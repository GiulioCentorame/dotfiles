#!/bin/sh
# A small screen capture script based on ffmpeg
# from https://adamsgaard.dk/screencasts.html
lockfile=/tmp/screenrecord.pid

startrecording() {
    out="$HOME/screenrecord-$(date '+%Y-%m-%d_%H:%M:%S').mkv"
    ffmpeg -y \
        -f x11grab \
        -framerate 60 \
        -s "$(xdpyinfo | grep dimensions | awk '{print $2}')" \
        -i $DISPLAY \
        -f alsa -i default \
        -r 30 \
        -c:v libx264rgb -crf 0 -preset ultrafast -c:a flac \
        "$out" >/dev/null 2>&1 &
    printf '%s' "$!" > "$lockfile"

    sleep 1
    if [ ! -f "$out" ]; then
        echo 'error: ffmpeg recording did not start' >&2
        notify-send -u CRITICAL "${0##*/}" 'ffmpeg recording did not start'
        rm -f "$lockfile"
        exit 1
    fi
}

stoprecording() {
    kill "$(cat "$lockfile")"
    rm -f "$lockfile"
    notify-send "${0##*/}" 'recording ended'
}

if [ -f "$lockfile" ]; then
    stoprecording
else
    startrecording
fi
